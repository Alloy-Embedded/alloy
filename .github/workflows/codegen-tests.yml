name: Code Generator Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tools/codegen/**'
      - '.github/workflows/codegen-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'tools/codegen/**'
      - '.github/workflows/codegen-tests.yml'

jobs:
  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc g++ build-essential

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install llvm@21
        echo "$(brew --prefix llvm@21)/bin" >> $GITHUB_PATH
        # Verify Clang 21 installation
        clang --version

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('tools/codegen/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        cd tools/codegen
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-timeout

    - name: Run tests
      run: |
        cd tools/codegen
        pytest tests/test_*.py -v --tb=short

    - name: Run tests with coverage
      run: |
        cd tools/codegen
        pytest tests/test_*.py --cov=cli/generators --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./tools/codegen/coverage.xml
        flags: codegen
        name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false

  compilation-test:
    name: Compilation Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install C++ compiler
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y g++-11
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 100
          g++ --version
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install llvm@21
          echo "$(brew --prefix llvm@21)/bin" >> $GITHUB_PATH
          echo "CC=$(brew --prefix llvm@21)/bin/clang" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix llvm@21)/bin/clang++" >> $GITHUB_ENV
          clang --version
        fi

    - name: Install Python dependencies
      run: |
        cd tools/codegen
        pip install pytest pytest-timeout

    - name: Run compilation tests
      run: |
        cd tools/codegen
        pytest tests/test_compilation.py -v --tb=short

  quality-check:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install pytest pytest-cov

    - name: Check test count
      run: |
        cd tools/codegen
        TEST_COUNT=$(pytest tests/test_*.py --collect-only -q | grep -c "test_")
        echo "Total tests: $TEST_COUNT"
        if [ $TEST_COUNT -lt 60 ]; then
          echo "❌ Not enough tests! Expected at least 60, got $TEST_COUNT"
          exit 1
        fi
        echo "✅ Test count OK: $TEST_COUNT tests"

    - name: Check coverage threshold
      run: |
        cd tools/codegen
        coverage run -m pytest tests/test_*.py
        coverage report --include="cli/generators/*" > coverage.txt
        cat coverage.txt
        # Extract coverage percentage
        COVERAGE=$(grep "TOTAL" coverage.txt | awk '{print $NF}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if [ $(echo "$COVERAGE < 40" | bc) -eq 1 ]; then
          echo "❌ Coverage too low! Expected at least 40%, got $COVERAGE%"
          exit 1
        fi
        echo "✅ Coverage OK: $COVERAGE%"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, compilation-test, quality-check]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Compilation Tests | ${{ needs.compilation-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Quality Check | ${{ needs.quality-check.result }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.compilation-test.result }}" != "success" ] || \
           [ "${{ needs.quality-check.result }}" != "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ Some tests failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
