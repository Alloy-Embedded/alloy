{
  "family": "stm32g0",
  "mcu": "stm32g0b1",
  "vendor": "st",
  "peripheral_name": "USB",
  "description": "Universal Serial Bus Full-Speed Device",
  "register_type": "USB_Registers",
  "register_namespace": "usb",
  "register_include": "hal/vendors/st/stm32g0/registers/usb_registers.hpp",
  "bitfield_include": "hal/vendors/st/stm32g0/bitfields/usb_bitfields.hpp",
  "platform_namespace": "alloy::hal::st::stm32g0",
  "vendor_namespace": "alloy::hal::st::stm32g0",

  "features": {
    "full_speed": true,
    "dma_support": false,
    "endpoints": 8,
    "double_buffering": true,
    "lpm": true,
    "bcd": true
  },

  "usb_bases": {
    "USB": "0x40005C00"
  },

  "template_params": [
    {
      "name": "BASE_ADDR",
      "type": "uint32_t",
      "description": "Peripheral base address"
    },
    {
      "name": "PERIPH_CLOCK_HZ",
      "type": "uint32_t",
      "description": "Peripheral clock frequency in Hz"
    }
  ],

  "policy_methods": {
    "description": "Hardware Policy methods for USB on STM32G0",
    "peripheral_clock_hz": 48000000,
    "mock_hook_prefix": "ALLOY_USB_MOCK_HW",

    "hw_accessor": {
      "description": "Get pointer to hardware registers",
      "return_type": "volatile RegisterType*",
      "code": "return reinterpret_cast<volatile RegisterType*>(BASE_ADDR);"
    },

    "enable_usb": {
      "description": "Enable USB peripheral",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR &= ~(1U << 1);",
      "test_hook": "ALLOY_USB_TEST_HOOK_PDWN",
      "notes": "Clear PDWN bit in CNTR"
    },

    "disable_usb": {
      "description": "Disable USB peripheral (power down)",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 1);",
      "test_hook": "ALLOY_USB_TEST_HOOK_PDWN",
      "notes": "Set PDWN bit in CNTR"
    },

    "force_reset": {
      "description": "Force USB reset",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 0);",
      "test_hook": "ALLOY_USB_TEST_HOOK_FRES",
      "notes": "FRES bit in CNTR"
    },

    "clear_reset": {
      "description": "Clear USB reset",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR &= ~(1U << 0);",
      "test_hook": "ALLOY_USB_TEST_HOOK_FRES"
    },

    "set_device_address": {
      "description": "Set USB device address",
      "parameters": [
        {"name": "address", "type": "uint8_t", "description": "Device address (0-127)"}
      ],
      "return_type": "void",
      "code": "hw()->USB_DADDR = (hw()->USB_DADDR & ~0x7F) | (address & 0x7F);",
      "test_hook": "ALLOY_USB_TEST_HOOK_ADD"
    },

    "enable_function": {
      "description": "Enable USB function",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_DADDR |= (1U << 7);",
      "test_hook": "ALLOY_USB_TEST_HOOK_EF",
      "notes": "EF bit in DADDR"
    },

    "disable_function": {
      "description": "Disable USB function",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_DADDR &= ~(1U << 7);",
      "test_hook": "ALLOY_USB_TEST_HOOK_EF"
    },

    "enable_reset_interrupt": {
      "description": "Enable USB reset interrupt",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 10);",
      "test_hook": "ALLOY_USB_TEST_HOOK_RESETM",
      "notes": "RESETM bit in CNTR"
    },

    "enable_suspend_interrupt": {
      "description": "Enable suspend mode interrupt",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 11);",
      "test_hook": "ALLOY_USB_TEST_HOOK_SUSPM",
      "notes": "SUSPM bit in CNTR"
    },

    "enable_wakeup_interrupt": {
      "description": "Enable wakeup interrupt",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 12);",
      "test_hook": "ALLOY_USB_TEST_HOOK_WKUPM",
      "notes": "WKUPM bit in CNTR"
    },

    "enable_correct_transfer_interrupt": {
      "description": "Enable correct transfer interrupt",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_CNTR |= (1U << 15);",
      "test_hook": "ALLOY_USB_TEST_HOOK_CTRM",
      "notes": "CTRM bit in CNTR"
    },

    "is_reset_flag_set": {
      "description": "Check if reset flag is set",
      "parameters": [],
      "return_type": "bool",
      "code": "return (hw()->USB_ISTR & (1U << 10)) != 0;",
      "test_hook": "ALLOY_USB_TEST_HOOK_RESET",
      "notes": "RESET bit in ISTR"
    },

    "is_suspend_flag_set": {
      "description": "Check if suspend flag is set",
      "parameters": [],
      "return_type": "bool",
      "code": "return (hw()->USB_ISTR & (1U << 11)) != 0;",
      "test_hook": "ALLOY_USB_TEST_HOOK_SUSP",
      "notes": "SUSP bit in ISTR"
    },

    "is_correct_transfer_flag_set": {
      "description": "Check if correct transfer flag is set",
      "parameters": [],
      "return_type": "bool",
      "code": "return (hw()->USB_ISTR & (1U << 15)) != 0;",
      "test_hook": "ALLOY_USB_TEST_HOOK_CTR",
      "notes": "CTR bit in ISTR"
    },

    "clear_reset_flag": {
      "description": "Clear reset interrupt flag",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_ISTR &= ~(1U << 10);",
      "test_hook": "ALLOY_USB_TEST_HOOK_RESET"
    },

    "clear_suspend_flag": {
      "description": "Clear suspend interrupt flag",
      "parameters": [],
      "return_type": "void",
      "code": "hw()->USB_ISTR &= ~(1U << 11);",
      "test_hook": "ALLOY_USB_TEST_HOOK_SUSP"
    },

    "get_endpoint_id": {
      "description": "Get endpoint identifier from interrupt",
      "parameters": [],
      "return_type": "uint8_t",
      "code": "return static_cast<uint8_t>(hw()->USB_ISTR & 0xF);",
      "test_hook": "ALLOY_USB_TEST_HOOK_EP_ID",
      "notes": "EP_ID[3:0] in ISTR"
    },

    "get_buffer_table_address": {
      "description": "Get buffer table address offset",
      "parameters": [],
      "return_type": "uint16_t",
      "code": "return static_cast<uint16_t>(hw()->USB_BTABLE & 0xFFF8);",
      "test_hook": "ALLOY_USB_TEST_HOOK_BTABLE"
    },

    "set_buffer_table_address": {
      "description": "Set buffer table address offset",
      "parameters": [
        {"name": "offset", "type": "uint16_t", "description": "Buffer table offset (must be 8-byte aligned)"}
      ],
      "return_type": "void",
      "code": "hw()->USB_BTABLE = offset & 0xFFF8;",
      "test_hook": "ALLOY_USB_TEST_HOOK_BTABLE"
    }
  }
}
