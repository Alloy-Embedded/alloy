/**
 * @file startup_{{ family }}_generated.cpp
 * @brief Auto-generated Startup Code for {{ mcu }}
 *
 * Generated from: {{ metadata_file }}
 * Generator: {{ generator_script }}
 * Template: {{ template_file }}
 *
 * DO NOT EDIT THIS FILE MANUALLY!
 * Regenerate with: ./tools/codegen/cli/generators/generate_startup.sh {{ family }}
 *
 * MCU: {{ mcu }}
 * Architecture: {{ arch }}
 * CPU Frequency: {{ clock.default_cpu_freq // 1000000 }} MHz
 * Vectors: {{ vector_table.total_vectors }} ({{ vector_table.standard_exceptions }} exceptions + {{ vector_table.irq_count }} IRQs)
 */

#include "hal/vendors/arm/{{ arch }}/startup_impl.hpp"
#include "hal/vendors/arm/{{ arch }}/vector_table.hpp"
#include "startup_config.hpp"

using namespace alloy::hal::arm;
using namespace alloy::hal::{{ family }};

// =============================================================================
// Forward Declarations
// =============================================================================

extern "C" {
    void Reset_Handler();
    void Default_Handler();
    void NMI_Handler();
    void HardFault_Handler();
    void MemManage_Handler();
    void BusFault_Handler();
    void UsageFault_Handler();
    void SVC_Handler();
    void DebugMon_Handler();
    void PendSV_Handler();
    void SysTick_Handler();

    // {{ mcu }} specific IRQ handlers (weak aliases to Default_Handler)
    // These can be overridden by application
{% for handler in vector_table.handlers %}
    void {{ handler.name }}() __attribute__((weak, alias("Default_Handler")));
{% endfor %}
}

// =============================================================================
// Exception Handlers
// =============================================================================

/**
 * @brief Default handler for unhandled exceptions
 *
 * Infinite loop with NOP (visible in debugger).
 */
extern "C" void Default_Handler() {
    while (true) {
        __asm volatile("nop");
    }
}

/**
 * @brief Reset handler - entry point after reset
 *
 * Uses modern startup sequence with initialization hooks.
 */
extern "C" [[noreturn]] void Reset_Handler() {
    // Execute modern startup sequence
    StartupImpl::startup_sequence<StartupConfig>();

    // Never returns
}

/**
 * @brief NMI handler
 */
extern "C" void NMI_Handler() {
    while (true) {}
}

/**
 * @brief Hard fault handler
 */
extern "C" void HardFault_Handler() {
    while (true) {}
}

/**
 * @brief Memory management fault handler
 */
extern "C" void MemManage_Handler() {
    while (true) {}
}

/**
 * @brief Bus fault handler
 */
extern "C" void BusFault_Handler() {
    while (true) {}
}

/**
 * @brief Usage fault handler
 */
extern "C" void UsageFault_Handler() {
    while (true) {}
}

/**
 * @brief SVCall handler
 */
extern "C" void SVC_Handler() {
    // Empty - used by RTOS
}

/**
 * @brief Debug monitor handler
 */
extern "C" void DebugMon_Handler() {
    // Empty - used by debugger
}

/**
 * @brief PendSV handler
 */
extern "C" void PendSV_Handler() {
    // Empty - used by RTOS
}

/**
 * @brief SysTick handler (defined in board.cpp)
 */
// extern "C" void SysTick_Handler() is defined in board.cpp

// =============================================================================
// Vector Table (Compile-Time Construction)
// =============================================================================

/**
 * @brief {{ mcu }} vector table
 *
 * Built at compile time using constexpr.
 * Zero runtime overhead.
 *
 * Memory configuration:
 * - Flash: {{ memory.flash.base }} ({{ memory.flash.size | int(base=16) // 1024 }} KB)
 * - SRAM:  {{ memory.sram.base }} ({{ memory.sram.size | int(base=16) // 1024 }} KB)
 * - Stack: {{ memory.stack_size | int(base=16) // 1024 }} KB
 *
 * Clock configuration:
 * - CPU: {{ clock.default_cpu_freq // 1000000 }} MHz
 * - SysTick: {{ clock.default_systick_freq }} Hz
 */
constexpr auto {{ family }}_vector_table = make_vector_table<StartupConfig::VECTOR_COUNT>()
    // Initial stack pointer and reset
    .set_stack_pointer(StartupConfig::stack_top())
    .set_reset_handler(&Reset_Handler)

    // Standard Cortex-M exceptions
    .set_nmi_handler(&NMI_Handler)
    .set_hard_fault_handler(&HardFault_Handler)
    .set_handler(StartupConfig::MEM_MANAGE_HANDLER_IDX, &MemManage_Handler)
    .set_handler(StartupConfig::BUS_FAULT_HANDLER_IDX, &BusFault_Handler)
    .set_handler(StartupConfig::USAGE_FAULT_HANDLER_IDX, &UsageFault_Handler)
    .set_handler(StartupConfig::SVCALL_HANDLER_IDX, &SVC_Handler)
    .set_handler(StartupConfig::DEBUG_MON_HANDLER_IDX, &DebugMon_Handler)
    .set_handler(StartupConfig::PENDSV_HANDLER_IDX, &PendSV_Handler)
    .set_systick_handler(&SysTick_Handler)

    // {{ mcu }}-specific IRQs ({{ vector_table.standard_exceptions }}-{{ vector_table.total_vectors - 1 }})
{% for handler in vector_table.handlers %}
    .set_handler({{ handler.index }}, &{{ handler.name }})      // IRQ {{ handler.irq_number }}: {{ handler.description }}
{% endfor %}

    // Reserved vectors set to nullptr
    .set_reserved_null()

    .get();

/**
 * @brief Place vector table in .isr_vector section
 *
 * Linker script places this at the beginning of flash.
 */
__attribute__((section(".isr_vector"), used))
const auto vectors = {{ family }}_vector_table;

/**
 * @brief Verify vector table at compile time
 *
 * Ensure vector table was constructed correctly.
 */
static_assert({{ family }}_vector_table.size() == StartupConfig::VECTOR_COUNT,
              "Vector table size mismatch");

/**
 * @brief Generation information
 *
 * This file was auto-generated with the following configuration:
 *
 * Metadata: {{ metadata_file }}
 * Generator: {{ generator_script }}
 * Template: {{ template_file }}
 * Date: {{ generation_date }}
 *
 * Initialization hooks:
{% if init_hooks.early_init.enabled %}
 * - early_init(): {{ init_hooks.early_init.description }}
{% endif %}
{% if init_hooks.pre_main_init.enabled %}
 * - pre_main_init(): {{ init_hooks.pre_main_init.description }}
{% endif %}
{% if init_hooks.late_init.enabled %}
 * - late_init(): {{ init_hooks.late_init.description }}
{% endif %}
 *
 * Features:
{% if features.fpu %}
 * - FPU: Yes
{% endif %}
{% if features.mpu %}
 * - MPU: Yes
{% endif %}
{% if features.cache %}
 * - Cache: I-cache={{ features.cache.instruction_cache }}, D-cache={{ features.cache.data_cache }}
{% endif %}
{% if features.dsp %}
 * - DSP: Yes
{% endif %}
 */
