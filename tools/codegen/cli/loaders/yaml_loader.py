"""
YAML Database Loader for Alloy CLI.

Provides safe YAML loading with support for:
- Multiline strings (no escaping needed)
- Inline comments
- Clean code snippets
- Better readability than JSON
"""

from pathlib import Path
from typing import Any, Dict, Optional
import yaml


class YAMLDatabaseLoader:
    """
    Load database files in YAML format.

    Features:
    - Safe loading (yaml.safe_load) for security
    - Multiline string support
    - Comment preservation metadata
    - Proper error handling with line numbers
    """

    @staticmethod
    def load(file_path: Path) -> Dict[str, Any]:
        """
        Load YAML file and return parsed data.

        Args:
            file_path: Path to YAML file

        Returns:
            Parsed YAML data as dictionary

        Raises:
            FileNotFoundError: If file doesn't exist
            yaml.YAMLError: If YAML is malformed
        """
        if not file_path.exists():
            raise FileNotFoundError(f"YAML file not found: {file_path}")

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = yaml.safe_load(f)

            if data is None:
                return {}

            return data

        except yaml.YAMLError as e:
            # Extract line number and context from error
            if hasattr(e, 'problem_mark'):
                mark = e.problem_mark
                error_msg = (
                    f"YAML syntax error in {file_path}:\n"
                    f"  Line {mark.line + 1}, Column {mark.column + 1}\n"
                    f"  {e.problem}"
                )
            else:
                error_msg = f"YAML syntax error in {file_path}: {e}"

            raise yaml.YAMLError(error_msg) from e

    @staticmethod
    def load_all(file_path: Path) -> list[Dict[str, Any]]:
        """
        Load YAML file with multiple documents.

        Args:
            file_path: Path to YAML file

        Returns:
            List of parsed YAML documents
        """
        if not file_path.exists():
            raise FileNotFoundError(f"YAML file not found: {file_path}")

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                documents = list(yaml.safe_load_all(f))

            return documents

        except yaml.YAMLError as e:
            if hasattr(e, 'problem_mark'):
                mark = e.problem_mark
                error_msg = (
                    f"YAML syntax error in {file_path}:\n"
                    f"  Line {mark.line + 1}, Column {mark.column + 1}\n"
                    f"  {e.problem}"
                )
            else:
                error_msg = f"YAML syntax error in {file_path}: {e}"

            raise yaml.YAMLError(error_msg) from e

    @staticmethod
    def validate_schema(data: Dict[str, Any], schema_version: str = "1.0") -> bool:
        """
        Validate YAML data has required schema_version field.

        Args:
            data: Parsed YAML data
            schema_version: Expected schema version

        Returns:
            True if valid

        Raises:
            ValueError: If schema validation fails
        """
        if "schema_version" not in data:
            raise ValueError(
                "YAML file must have 'schema_version' field at top level"
            )

        if data["schema_version"] != schema_version:
            raise ValueError(
                f"Schema version mismatch: expected {schema_version}, "
                f"got {data['schema_version']}"
            )

        return True

    @staticmethod
    def save(file_path: Path, data: Dict[str, Any], add_comments: bool = False) -> None:
        """
        Save data to YAML file.

        Args:
            file_path: Path to save YAML file
            data: Data to save
            add_comments: Whether to add helpful comments (default False)
        """
        file_path.parent.mkdir(parents=True, exist_ok=True)

        with open(file_path, 'w', encoding='utf-8') as f:
            if add_comments:
                # Add header comment
                f.write("# Alloy Framework Metadata\n")
                f.write(f"# Generated by Alloy CLI v2.0.0\n")
                f.write(f"# Schema version: {data.get('schema_version', '1.0')}\n")
                f.write("\n")

            yaml.dump(
                data,
                f,
                default_flow_style=False,
                allow_unicode=True,
                sort_keys=False,
                width=100,
                indent=2
            )


class YAMLValidationError(Exception):
    """Raised when YAML validation fails."""
    pass
